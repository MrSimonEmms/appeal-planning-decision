<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - tasks/uploadFilesToBlobStorage.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato.css" rel="stylesheet" type="text/css">
  <link href="../../assets/css/plato-file.css" rel="stylesheet" type="text/css">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://github.com/the-simian/es6-plato">ES6 Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
      <li class="active">
        <a href="display.html">Summary Display</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>tasks/uploadFilesToBlobStorage.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">64.91</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">240</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">21.63</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.38</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
 * Upload Files To Blob Storage
 *
 * This gets the un-uploaded files and pushes them
 * to Blob Storage
 */

const fs = require(&#039;fs&#039;);
const path = require(&#039;path&#039;);
const mongoose = require(&#039;mongoose&#039;);
const { functional } = require(&#039;@pins/common&#039;);
const { BlobServiceClient } = require(&#039;@azure/storage-blob&#039;);
const Documents = require(&#039;../schemas/documents&#039;);
const config = require(&#039;../lib/config&#039;);
const logger = require(&#039;../lib/logger&#039;);
const bootstrap = require(&#039;../lib/mongooseBootstrap&#039;);

/**
 * Connect To Blob Storage
 *
 * Connects the blob storage
 *
 * @returns {Promise&lt;{blobClient: BlobServiceClient, containerClient: ContainerClient}&gt;}
 */
async function connectToBlobStorage() {
  logger.info(&#039;Connecting to blob storage&#039;);

  try {
    /* Configure Blob Storage client */
    const blobClient = BlobServiceClient.fromConnectionString(config.storage.connectionString);
    const containerClient = blobClient.getContainerClient(config.storage.container);

    logger.info({ container: config.storage.container }, &#039;Creating container if not present&#039;);

    await containerClient.createIfNotExists();

    logger.info(&#039;Successfully connected to blob storage&#039;);

    return {
      blobClient,
      containerClient,
    };
  } catch (err) {
    logger.error({ err }, &#039;Failed to connect to blob storage&#039;);

    /* Preserve the error */
    throw err;
  }
}

/**
 * Get Files To Process
 *
 * Returns an array of objects to process, with the
 * oldest first.
 *
 * @returns {Promise&lt;*&gt;}
 */
async function getFilesToProcess() {
  try {
    logger.info(&#039;Getting files to process&#039;);

    const files = await Documents.find({
      &#039;upload.processed&#039;: false,
      &#039;upload.processAttempts&#039;: {
        $lt: config.storage.processMaxAttempts,
      },
    })
      .limit(config.storage.processQueryLimit)
      .sort({ createdAt: 1 });

    logger.info({ files, count: files.length }, &#039;Files found&#039;);

    return files;
  } catch (err) {
    logger.error({ err }, &#039;Error getting files to process&#039;);

    throw err;
  }
}

/**
 * Increment Attempts
 *
 * Increments an attempt at uploading a file in
 * the database
 *
 * @param docs
 * @returns {Promise&lt;unknown[]&gt;}
 */
async function incrementAttempts(docs) {
  const docList = await Promise.all(
    docs.map(async (item) =&gt; {
      logger.info({ id: item.id }, &#039;Incrementing a process attempt&#039;);

      try {
        await Documents.findOneAndUpdate(
          { id: item.id },
          {
            $inc: {
              &#039;upload.processAttempts&#039;: 1,
            },
          }
        );
      } catch (err) {
        logger.error({ err }, &#039;Error incrementing a process attempt - file will not be processed&#039;);
        return false;
      }

      return item;
    })
  );

  /* Remove anything that&#039;s errored */
  return docList.filter((item) =&gt; item);
}

/**
 * Upload To Blob Storage
 *
 * Uploads each of the selected documents to blob storage
 *
 * @param blobStorageClient
 * @returns {function(*): Promise&lt;unknown[]&gt;}
 */
function uploadToBlobStorage(blobStorageClient) {
  return (docs) =&gt;
    Promise.all(
      docs.map(async (doc) =&gt; {
        let uploaded = false;
        const filePath = path.join(config.fileUpload.path, doc.location);

        try {
          const blobName = `${doc.applicationId}/${doc.id}/${doc.name}`;
          logger.info({ blobName, doc, filePath }, &#039;Uploading file to blob storage&#039;);

          const blockBlobClient = blobStorageClient.getBlockBlobClient(blobName);
          const readableStream = fs.createReadStream(filePath);
          const uploadStatus = await blockBlobClient.uploadStream(
            readableStream,
            undefined,
            undefined,
            {
              blobHTTPHeaders: {
                blobContentType: doc.mimeType,
              },
            }
          );

          uploaded = true;
          logger.info({ doc, uploadStatus }, &#039;File successfully uploaded&#039;);
        } catch (err) {
          logger.error({ err, doc }, &#039;File upload failed&#039;);
        }

        /* Housekeeping job - this doesn&#039;t affect the process */
        try {
          logger.info({ doc, filePath }, &#039;Deleting local document&#039;);

          await fs.promises.unlink(filePath);

          logger.info({ doc, filePath }, &#039;Deleted uploaded document&#039;);
        } catch (err) {
          logger.error({ err, doc }, &#039;Error deleting document&#039;);
        }

        return {
          uploaded,
          doc,
        };
      })
    );
}

/**
 * Update Upload Status
 *
 * Updates the upload status and deletes the local file
 *
 * @param docs
 * @returns {Promise&lt;unknown[]&gt;}
 */
async function updateUploadStatus(docs) {
  return Promise.all(
    docs.map(async ({ uploaded, doc }) =&gt; {
      if (uploaded) {
        try {
          /* File has been uploaded - update the database */
          return await Documents.findOneAndUpdate(
            { id: doc.id },
            {
              &#039;upload.processed&#039;: true,
            },
            {
              new: true,
            }
          );
        } catch (err) {
          logger.error({ err }, &#039;Failed to update upload state&#039;);
        }
      }

      return docs;
    })
  );
}

async function main() {
  logger.info({ config }, &#039;Starting upload process&#039;);

  await bootstrap();

  const { containerClient } = await connectToBlobStorage();

  const data = await functional.flow([
    incrementAttempts,
    uploadToBlobStorage(containerClient),
    updateUploadStatus,
  ])(await getFilesToProcess());

  logger.debug({ data }, &#039;Functional programming flow finished&#039;);

  logger.info({ data }, &#039;Upload process finished&#039;);

  /* Close mongoose connection */
  await mongoose.connection.close();

  logger.info(&#039;Mongoose connect closed&#039;);
}

main()
  .then(() =&gt; {
    logger.info(&#039;Bye&#039;);
    process.exit(0);
  })
  .catch(async (err) =&gt; {
    logger.fatal({ err }, &#039;Upload service errored&#039;);
    process.exit(1);
  });
</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
